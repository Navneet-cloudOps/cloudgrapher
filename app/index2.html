<!doctype html>
<html lang="en" class="no-js">
    <head>
        <meta charset="utf-8">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../bower_components/foundation/css/normalize.css">
  <link rel="stylesheet" href="../bower_components/foundation/css/foundation.css">
  <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="../bower_components/vis/dist/vis.css">
        <title>cfedit</title>
        <script src="../bower_components/foundation/js/vendor/modernizr.js"></script>
        </head>
    <body>
        <header>
        <!--[if lt IE 10]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
            <h1>CloudFormation editor</h1>
            <div class="button-bar">
                <ul class="button-group">
                    <li><a href="#" class="button">Open template</a></li>
                    <li><a id="save_template" href="#" class="button">Save template</a></li>
                </ul>
                <ul class="button-group right">
                    <li><a id="save_graph" href="#" class="button">Save graph as PNG</a></li>
                </ul>
            </div>
                <div id="templateStatus" data-alert class="alert-box success" tabindex="0" aria-live="assertive" role="dialogalert">
                    <strong id="statusTitle">Your content goes here</strong>
                    </div>
            <hr />
        </header>
        <main>
            <div id="cfeditor" class="row">
                <div class="column small-12 medium-6" >
                    <div id="jsoneditor"></div>
                </div>
                <div class="column small-12 medium-6">
                    <h3 class="graphheader">Graph representation</h3>
                    <span class="show-for-medium-up" style="height: 58px">&nbsp;</span>
                    <div id="graph-container" class="panel callout"><h4><em>None</em></h4></div>
                </div>
            </div>
        </main>
        <footer>
            <hr />
            <span>Hi, this is the footer but it has no content!</span>
        </footer>
        <script src="schema/cloudformation.json"></script>
        <script src="../bower_components/js-beautify/js/lib/beautify.js"></script>
        <script src="../bower_components/canvas-toBlob.js/canvas-toBlob.js"></script>
        <script src="../bower_components/FileSaver/FileSaver.js"></script>
        <script src="../bower_components/vis/dist/vis.js"></script>
        <script src="../bower_components/json-editor/dist/jsoneditor.js"></script>
        <script src="../bower_components/foundation/js/vendor/jquery.js"></script>
        <script src="../bower_components/foundation/js/foundation.min.js"></script>
        <script language="javascript">
            JSONEditor.defaults.options.theme = 'foundation5';
            JSONEditor.defaults.options.iconlib = 'fontawesome4';
            var cfeditor = document.getElementById('cfeditor');
            var errors = [];
            var graph = undefined;
            var graphcontainer = document.getElementById('graph-container');
            var graphOptions = {}

            var editor = new JSONEditor(document.getElementById('jsoneditor'), {
                   schema: schema
                   });
            var check_valid = function() {
                errors = editor.validate();
                var templateStatus = document.getElementById('templateStatus');
                var statusTitle = document.getElementById('statusTitle');
                var errorlist = templateStatus.getElementsByTagName('ul');
                if (errorlist.length > 0) {
                  templateStatus.removeChild(errorlist[0]);
                }
                if (errors.length > 0) {
                    templateStatus.className = 'alert-box alert';
                    statusTitle.innerHTML="Error(s): ";
                    errorlist = document.createElement('ul');
                    errors.forEach(function(err){
                        var li = document.createElement('li');
                        li.appendChild(document.createTextNode(err.path + ' [' + err.property + '] ' + err.message));
                        errorlist.appendChild(li);
                        });
                    templateStatus.appendChild(errorlist);
                }
                else {
                    templateStatus.className = 'alert-box success';
                    statusTitle.innerHTML="Valid";
                }
            };
            editor.on('change', check_valid);
            editor.getEditor('root').canHaveAdditionalProperties = function() { return false};
            cfeditor.addEventListener('dragover', function(evt) {
                evt.stopPropagation();
                evt.preventDefault();
                evt.dataTransfer.dropEffect = 'copy';
            }, false);
            cfeditor.addEventListener('drop', function(evt) {
                evt.stopPropagation();
                evt.preventDefault();

                var files = evt.dataTransfer.files;
                var reader = new FileReader();
                reader.onload = function () {
                    cfscript = JSON.parse(reader.result);
                    if (cfscript) {
                        editor.off('change', check_valid);
                        editor.setValue(cfscript);
                        var data = { nodes:[], edges:[] };
                        for (var r in cfscript['Resources']) {
                            data.nodes.push({
                                id: r,
                                label: r
                            });
                        }
                        if(graph == undefined){
                            graph = new vis.Network(graphcontainer, data, graphOptions);
                            graphcontainer.className = graphcontainer.className.replace(/(?:^|\s)callout(?!\S)/g , '');
                        }
                        else {
                            graph.setData(data);
                        }
                        editor.on('change', check_valid);
                    }
                };
                reader.readAsText(files[0]);
            }, false);
                var saveImage = function() {
                    var canvas = graphcontainer.getElementsByTagName('canvas');
                    if (canvas && canvas.length == 1) {
                        canvas[0].toBlob(function(blob){
                                saveAs(blob, 'cloudformation_resources.png');
                                });
                    }
                    else {
                        console.log('Expected to find one canvas but got ' + canvas);
                    }
                };
                var saveTemplate = function() {
                    var prettyDoc = js_beautify(JSON.stringify(editor.getValue(), function(k,v){return v == null ? "" : v;}));
                    var blob = new Blob([prettyDoc], {type: "text/plain;charset=utf-8"});
                    saveAs(blob, "cloudformation_template.json");
                    console.log(prettyDoc);
                };
                $('#save_template').click(function(){ saveTemplate(); return false;});
                $('#save_graph').click(function(){ saveImage(); return false;});
                check_valid();
        </script>
    </body>
</html>
