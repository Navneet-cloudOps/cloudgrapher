{"version":3,"sources":["node_modules/browserify/node_modules/browser-pack/_prelude.js","app/scripts/collectdata.js","edit.bundle.js","app/scripts/edit.js","app/scripts/findedges.js","app/scripts/queryparser.js","app/scripts/template.js"],"names":["e","t","n","r","s","o","u","a","require","i","f","Error","code","l","exports","call","length",1,"module","findEdges","graphOptions","nodes","brokenImage","edges","style","color.highlight","stabilize","zoomExtentOnStabilize","collectData","json","data","knownResources","possibleEdges","addEdge","toId","title","push","from","resourceKey","to","Resources","resource","props","Properties","group","Type","toLowerCase","replace","id","label","shape","image","filter","edge","indexOf","collectCyData","edgeFilters","AWS::EC2::SecurityGroupIngress","newTarget","source","target","AWS::EC2::SecurityGroupEgress","default","type","parent","get","awsType","this","edgeIndex","classes","./findedges",2,"myCodeMirror","CodeMirror","document","getElementById","value","lineNumbers","mode","foldGutter","gutters","lint","onUpdateLinting","annotations","template","refreshGraph","$","toggle","hasChanged","setSize","graphArea","css","addEventListener","evt","stopPropagation","preventDefault","dataTransfer","dropEffect","loadTemplate","fromFile","files","editor","setValue","getDoc","getValue","cytolib","cytoscape","graphContainer","jsonproxy","jsonp","ajax","url","dataType","success","responseText","changeStyle","isResizing","lastDownX","remoteInput","keypress","which","fromURL","getTemplateUrl","val","checkValidity","hide","loadFn","templateLocation","embedUrl","queryTools","createEmbedUrl","window","location","html","remove","alertify","reason","error","console","log","click","event","change","is","show","saveAs","Blob","text","description","saveWindow","open","onload","src","base64Image","setLayout","container","editorPane","on","clientX","offsetRight","width","offset","left","fitGraph","ready","parser","search","onTemplate","./queryparser","./template",3,"findIn","start","makeEdge","Array","forEach","elem","Object","keys","fn","join","key","k",4,"callbacks","queryMap","URI","CFTemplateURL","host",5,"options","graph","initialData","collector","defaultContainer","cyto","layoutName","file","fail","reader","FileReader","setData","result","name","readAsText","onSuccess","onError","dataString","JSON","stringify","dataObject","parse","elements","layout","padding","boxSelectionEnabled","Description","center","fit","png","full","corsSupport","textStatus","message","status","statusText","indent","changed","./collectdata"],"mappings":"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","file":"edit.bundle.js","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","/* jshint devel:true */\n/* global exports, require */\nvar findEdges = require('./findedges').findEdges;\nexports.graphOptions = {\n  'nodes': {\n    'brokenImage': 'images/unknown.png'\n  },\n  'edges': {\n    'style' : 'arrow',\n    'color.highlight': 'red'\n  },\n  'stabilize': true,\n  'zoomExtentOnStabilize': true\n};\nexports.collectData = function(json) {\n  'use strict';\n  var data = { nodes:[], edges:[] };\n  var knownResources = [];\n  var possibleEdges = [];\n  var addEdge = function (toId, title){\n    possibleEdges.push( {'from': resourceKey, 'to': toId, 'title': title } );\n  };\n  for (var resourceKey in json.Resources) {\n    var resource = json.Resources[resourceKey];\n    var props = resource.Properties;\n    var group = resource.Type.toLowerCase().replace(/::/g,'-');\n    knownResources.push(resourceKey);\n    data.nodes.push({\n      'id'   : resourceKey,\n      'label': resourceKey,\n      'group': group,\n      'shape': 'image',\n      'image': 'images/' + group + '.png'\n    });\n    findEdges(props, addEdge);\n  }\n  data.edges = possibleEdges.filter(function(edge) {\n    return edge && knownResources.indexOf(edge.to) >= 0;\n  });\n  return data;\n};\n\n\nexports.collectCyData = function(json) {\n  'use strict';\n  var edgeFilters = {\n    'AWS::EC2::SecurityGroupIngress': function(edge /*, source, target*/){\n      if (edge.data.resource === 'GroupId') {\n        // NOOP the direction is good\n      }\n      else if (edge.data.resource === 'SourceSecurityGroupId') {\n        var newTarget = edge.data.source;\n        edge.data.source = edge.data.target;\n        edge.data.target = newTarget;\n      }\n      return true;\n    },\n    'AWS::EC2::SecurityGroupEgress': function(edge /*, source, target*/) {\n      if (edge.data.resource === 'DestinationSecurityGroupId') {\n        // NOOP the direction is good\n      }\n      else if (edge.data.resource === 'GroupId') {\n        var newTarget = edge.data.source;\n        edge.data.source = edge.data.target;\n        edge.data.target = newTarget;\n      }\n      return true;\n    },\n    'default': function(edge, source, target) {\n      if (target && target.type === 'AWS::EC2::SecurityGroup' && source.type !== 'AWS::EC2::SecurityGroup'){\n        knownResources[edge.data.source].data.parent = edge.data.target;\n        return false;\n      }\n      return true;\n    },\n    'get': function(awsType) {\n      return this[awsType] || this['default'];\n    }\n  };\n  var data = { nodes:[], edges:[] };\n  var edgeIndex = 0;\n\n  var addEdge = function (toId, title, resource) {\n    possibleEdges.push({ data: { id: 'e'+ (edgeIndex++), source: resourceKey, target: toId, title: title, resource: resource }});\n  };\n\n  var knownResources = {};\n  var possibleEdges = [];\n\n  for (var resourceKey in json.Resources) {\n    var resource = json.Resources[resourceKey];\n    var r = {\n      data: {\n        id: resourceKey\n      },\n      classes: resource.Type.toLowerCase().replace(/::/g,'-'),\n      type: resource.Type\n    };\n    findEdges(resource.Properties, addEdge);\n    knownResources[resourceKey] = r;\n    data.nodes.push(r);\n  }\n\n  data.edges = possibleEdges.filter(function(edge) {\n    var source = knownResources[edge.data.source];\n    var target = knownResources[edge.data.target];\n    var filter = edgeFilters.get(source.type);\n    return edge && source && target && filter(edge, source, target);\n  });\n\n  return data;\n};\n","(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n/* jshint devel:true */\n/* global exports, require */\nvar findEdges = require('./findedges').findEdges;\nexports.graphOptions = {\n  'nodes': {\n    'brokenImage': 'images/unknown.png'\n  },\n  'edges': {\n    'style' : 'arrow',\n    'color.highlight': 'red'\n  },\n  'stabilize': true,\n  'zoomExtentOnStabilize': true\n};\nexports.collectData = function(json) {\n  'use strict';\n  var data = { nodes:[], edges:[] };\n  var knownResources = [];\n  var possibleEdges = [];\n  var addEdge = function (toId, title){\n    possibleEdges.push( {'from': resourceKey, 'to': toId, 'title': title } );\n  };\n  for (var resourceKey in json.Resources) {\n    var resource = json.Resources[resourceKey];\n    var props = resource.Properties;\n    var group = resource.Type.toLowerCase().replace(/::/g,'-');\n    knownResources.push(resourceKey);\n    data.nodes.push({\n      'id'   : resourceKey,\n      'label': resourceKey,\n      'group': group,\n      'shape': 'image',\n      'image': 'images/' + group + '.png'\n    });\n    findEdges(props, addEdge);\n  }\n  data.edges = possibleEdges.filter(function(edge) {\n    return edge && knownResources.indexOf(edge.to) >= 0;\n  });\n  return data;\n};\n\n\nexports.collectCyData = function(json) {\n  'use strict';\n  var edgeFilters = {\n    'AWS::EC2::SecurityGroupIngress': function(edge /*, source, target*/){\n      if (edge.data.resource === 'GroupId') {\n        // NOOP the direction is good\n      }\n      else if (edge.data.resource === 'SourceSecurityGroupId') {\n        var newTarget = edge.data.source;\n        edge.data.source = edge.data.target;\n        edge.data.target = newTarget;\n      }\n      return true;\n    },\n    'AWS::EC2::SecurityGroupEgress': function(edge /*, source, target*/) {\n      if (edge.data.resource === 'DestinationSecurityGroupId') {\n        // NOOP the direction is good\n      }\n      else if (edge.data.resource === 'GroupId') {\n        var newTarget = edge.data.source;\n        edge.data.source = edge.data.target;\n        edge.data.target = newTarget;\n      }\n      return true;\n    },\n    'default': function(edge, source, target) {\n      if (target && target.type === 'AWS::EC2::SecurityGroup' && source.type !== 'AWS::EC2::SecurityGroup'){\n        knownResources[edge.data.source].data.parent = edge.data.target;\n        return false;\n      }\n      return true;\n    },\n    'get': function(awsType) {\n      return this[awsType] || this['default'];\n    }\n  };\n  var data = { nodes:[], edges:[] };\n  var edgeIndex = 0;\n\n  var addEdge = function (toId, title, resource) {\n    possibleEdges.push({ data: { id: 'e'+ (edgeIndex++), source: resourceKey, target: toId, title: title, resource: resource }});\n  };\n\n  var knownResources = {};\n  var possibleEdges = [];\n\n  for (var resourceKey in json.Resources) {\n    var resource = json.Resources[resourceKey];\n    var r = {\n      data: {\n        id: resourceKey\n      },\n      classes: resource.Type.toLowerCase().replace(/::/g,'-'),\n      type: resource.Type\n    };\n    findEdges(resource.Properties, addEdge);\n    knownResources[resourceKey] = r;\n    data.nodes.push(r);\n  }\n\n  data.edges = possibleEdges.filter(function(edge) {\n    var source = knownResources[edge.data.source];\n    var target = knownResources[edge.data.target];\n    var filter = edgeFilters.get(source.type);\n    return edge && source && target && filter(edge, source, target);\n  });\n\n  return data;\n};\n\n},{\"./findedges\":3}],2:[function(require,module,exports){\n/* jshint devel:true */\n/* global saveAs, require, CodeMirror, alertify, cytoscape */\n\n(function() {\n  'use strict';\n\n  var myCodeMirror = new CodeMirror(document.getElementById('editor'), {\n    value: '{}',\n    lineNumbers: true,\n    mode: 'application/json',\n    foldGutter: true,\n    gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter', 'CodeMirror-lint-markers'],\n    lint: {\n      onUpdateLinting: function(annotations) {\n        if (template && (!annotations || annotations.length === 0)) {\n          template.refreshGraph();\n          $('#embed_link').toggle(!template.hasChanged());\n        }\n      }\n    }\n  });\n  myCodeMirror.setSize('100%', '800px');\n\n  var graphArea = $('#graph_area');\n\n  graphArea.css('background-image', 'url(\"images/aws-cloudformation-template.svg\")');\n  graphArea[0].addEventListener('dragover', function(evt) {\n    evt.stopPropagation();\n    evt.preventDefault();\n    evt.dataTransfer.dropEffect = 'copy';\n  }, false);\n  graphArea[0].addEventListener('drop', function(evt) {\n    evt.stopPropagation();\n    evt.preventDefault();\n    loadTemplate(template.fromFile, evt.dataTransfer.files[0]);\n  }, false);\n\n  var template = require('./template').template({\n    'editor': {\n      setValue: function(value) { myCodeMirror.getDoc().setValue(value); },\n      getValue: function() { return myCodeMirror.getDoc().getValue(); }\n    },\n    'cytolib': cytoscape,\n    'graphContainer': graphArea[0],\n    'jsonproxy': $.jsonp\n  });\n  $.ajax({\n    url: 'styles/main.cycss',\n    type: 'GET',\n    dataType: 'text',\n    success: function(responseText) {\n      template.changeStyle(responseText);\n    }\n  });\n\n  var isResizing = false,\n    lastDownX = 0;\n\n  var remoteInput = $('#remote_input');\n\n  $('#remote_input').keypress(function(e) {\n    if (e.which === 13) {\n      loadTemplate(template.fromURL, getTemplateUrl());\n      return false;\n    }\n  });\n\n  var getTemplateUrl = function () {\n    var url = remoteInput.val();\n    if (remoteInput[0].checkValidity()){\n      remoteInput.hide();\n      return url;\n    }\n    return undefined;\n  };\n\n  var loadTemplate = function(loadFn, url) {\n    if (!url) {\n      return;\n    }\n    loadFn(\n      url,\n      function(templateLocation) {\n        graphArea.css('background-image', '');\n        if (typeof url === 'string') {\n          if (remoteInput.val() !== url) {\n            remoteInput.val(url);\n          }\n          var embedUrl = queryTools.createEmbedUrl(window.location, url);\n          $('#embed_link').html('Use <a href=\"'+ embedUrl + '\">'+ embedUrl + '</a> to open directly');\n        }\n        else {\n          $('#embed_link > a').remove();\n        }\n        alertify.success('Loaded template \"' + templateLocation + '\" successfully');\n      },\n      function(templateLocation, reason, e) {\n        alertify.error('Unable to load template \"' + templateLocation + '\" because of ' + reason);\n        console.log(e);\n      }\n    );\n  };\n\n  $('#open_template').click(function(event) {\n    event.preventDefault();\n    $('#template_input').click();\n  });\n  $('#template_input').change(function(event) {\n    loadTemplate(template.fromFile, event.target.files[0]);\n  });\n\n  $('#open_url').click(function(event) {\n    event.preventDefault();\n    if (remoteInput.is(':visible')) {\n      loadTemplate(template.fromURL, getTemplateUrl());\n    }\n    else {\n      remoteInput.show();\n    }\n  });\n\n  $('#save_template').click(function(event) {\n    event.preventDefault();\n    saveAs(\n      new Blob( [template.text(2)], { type: 'text/plain;charset=utf-8' }),\n      template.description() + '.json'\n    );\n    return false;\n  });\n  $('#save_graph').click(function(event) {\n    event.preventDefault();\n    var saveWindow = window.open('savegraph.html');\n    saveWindow.onload = function() {\n      saveWindow.document.getElementById('graphPNG').src = template.base64Image();\n    };\n    return false;\n  });\n  $('#graph_layout').change(function() {\n    template.setLayout($('#graph_layout').val());\n  });\n\n  var container = $('#container'),\n    editorPane = $('#editor_pane');\n\n  $('#border').on('mousedown', function(e) {\n    isResizing = true;\n    lastDownX = e.clientX;\n  });\n\n  $(document).on('mousemove', function(e) {\n    // we don't want to do anything if we aren't resizing.\n    if (!isResizing) {\n      return;\n    }\n\n    var offsetRight = container.width() - (e.clientX - container.offset().left);\n\n    graphArea.css('right', offsetRight);\n    editorPane.css('width', offsetRight);\n  }).on('mouseup', function() {\n    if (isResizing) {\n      template.fitGraph();\n    }\n    // stop resizing\n    isResizing = false;\n  });\n  var queryTools = require('./queryparser');\n  $(document).ready(function() {\n        //----- Parse Query -----//\n  queryTools.parser(window.location.search,{\n    onTemplate: function (url) {\n      loadTemplate(template.fromURL, url);\n    }\n  });\n  //----- Parse Query -----//\n  });\n})();\n\n},{\"./queryparser\":4,\"./template\":5}],3:[function(require,module,exports){\n/* jshint devel:true */\n/* global exports */\n\n// findEdges/findIn\n//  - startElement element to traverse through\n//  - makeEdge     call back which expects a reference resource name and\n//                   title of the resource reference\n//  - title        resource title to push to callback function\n//\nexports.findEdges = function findIn (start, makeEdge, title) {\n  'use strict';\n  // If start is an array then let's loop through all elements to find edges\n  //\n  if (start instanceof Array) {\n    start.forEach(function(elem){\n      findIn(elem, makeEdge, title || '');\n    });\n  }\n  // Else if we hit some object and we should delve into it\n  //\n  else if (typeof start === 'object') {\n    // When we only have one key then it's probably some CloudFormation function\n    // we can use to make an make edge with\n    //\n    if (Object.keys(start).length === 1) {\n      var fn = Object.keys(start)[0];\n      // If we hit a Ref, it's definitely a reference of some sorts\n      // usually we only hit this option deep and the title should be available\n      // otherwise give an empty title\n      //\n      if (fn === 'Ref' && typeof start[fn] === 'string') {\n        makeEdge(start[fn], title || '', title);\n      }\n      // An Fn::Join is trickier, we might find edges recursively\n      //\n      else if (fn === 'Fn::Join' && start[fn] instanceof Array) {\n        start[fn][1].forEach(function(elem) {\n          findIn(elem, makeEdge, start[fn][1].join(start[fn][0]));\n        });\n      }\n      // If we see an Fn::GetAtt then make an edge with the reference,\n      // not the attribute\n      //\n      else if (fn === 'Fn::GetAtt' && start[fn] instanceof Array) {\n        makeEdge(start[fn][0], start[fn][1], title);\n      }\n      // Ok, forgot why this path is necessary, I guess it's when we didn't find\n      //  something to easily pull references from and we probably need to keep\n      //  searching anyway\n      //\n      else {\n        for (var key in start) {\n          findIn(start[key], makeEdge, key);\n        }\n      }\n    }\n    // if we have more than one key we have to delve deeper to find edges\n    //\n    else {\n      for (var k in start) {\n        findIn(start[k], makeEdge, k);\n      }\n    }\n  }\n};\n\n},{}],4:[function(require,module,exports){\n/* jshint devel:true */\n/* global exports, URI */\n\nexports.parser = function(url, callbacks) {\n    'use strict';\n    if (url) {\n        var queryMap = new URI(url).search(true);\n        if (queryMap.CFTemplateURL && callbacks.onTemplate) {\n            callbacks.onTemplate(queryMap.CFTemplateURL);\n        }\n    }\n};\n\nexports.createEmbedUrl = function(host, target) {\n    'use strict';\n    return new URI(host).search(function(data) {\n        data.CFTemplateURL = target;\n    });\n};\n},{}],5:[function(require,module,exports){\n/* jshint devel:true */\n/* global exports, require, cytoscape */\n\nexports.template = function(options) {\n  'use strict';\n\n  var editor = options.editor;\n  var collector = require('./collectdata');\n  var defaultContainer = options.graphContainer;\n  var jsonproxy = options.jsonproxy;\n  var graph;\n  var style;\n  var cyto = options.cytolib || cytoscape;\n  var initialData;\n  var layoutName = 'cose';\n\n  if (!editor || !editor.getValue) {\n    throw 'editor unavailable or doesn\\'t support getValue';\n  }\n  if (!cyto) {\n    throw 'graphing library Cytoscape unavailable';\n  }\n\n  var changeStyle = function(data) {\n    style = data;\n    if (graph) {\n      graph.style(style);\n    }\n  };\n\n  var fromFile = function(file, success, fail) {\n    var reader = new FileReader();\n    reader.onload = function() {\n      setData(reader.result, function() {\n        if (success) {\n          success(file.name);\n        }\n      }, function(reason, e) {\n        if (fail) {\n          fail(file.name, reason, e);\n        }\n      });\n\n    };\n    try {\n      reader.readAsText(file);\n    }\n    catch (e) {\n      if (fail) {\n        fail(file.name, e);\n      }\n    }\n  };\n\n  var setData = function(data, onSuccess, onError) {\n    if (data) {\n      try {\n        var dataString = typeof data === 'string' ? data : JSON.stringify(data, null, 2);\n        var dataObject = typeof data === 'object' ? data : JSON.parse(data);\n\n        editor.setValue(dataString);\n        initialData = text();\n        show(collector.collectCyData(dataObject));\n\n        if (onSuccess) {\n          onSuccess();\n        }\n      }\n      catch (e) {\n        if (onError) {\n          onError('Error processing data as JSON', e);\n        }\n      }\n    }\n    else {\n      if (onError) {\n        onError('No data');\n      }\n    }\n  };\n\n  var refreshGraph = function(){\n    show(collector.collectCyData(json()));\n  };\n\n  var show = function(data, container) {\n    if (!container && !defaultContainer) {\n      throw 'No container available to show data';\n    }\n    graph = cyto({\n      container: container || defaultContainer,\n      elements: data,\n      style: style,\n      layout: {\n        name: layoutName,\n        padding: 5\n      }\n    });\n    graph.boxSelectionEnabled(true);\n  };\n\n  var description = function() {\n    var description = 'template';\n    try {\n      description = json().Description;\n    }\n    catch (e) {}\n    return description;\n  };\n\n  var base64Image = function() {\n    if (!graph) {\n      return;\n    }\n    graph.center();\n    graph.fit();\n    return graph.png({\n      full: false\n    });\n  };\n\n  var json = function() {\n    return JSON.parse(editor.getValue());\n  };\n\n  var setLayout = function(name) {\n    layoutName = name;\n    if (graph) {\n      graph.layout({\n        'name': name\n      });\n    }\n  };\n\n  var fromURL = function(url, success, onError) {\n    if (!jsonproxy) {\n      throw 'No jsonproxy available to request URLs';\n    }\n    if (url) {\n      jsonproxy({\n        url: url,\n        corsSupport: true,\n        success: function(data) {\n          setData(data);\n          if (success) {\n            success(url);\n          }\n        },\n        error: function(data, textStatus) {\n            var message;\n            if (textStatus === 'parsererror') {\n              editor.setValue(data.responseText);\n              message = 'Unable to parse the result as valid JSON';\n            }\n            else {\n              message = 'Unable to load: status ' + data.status + ' ' + data.statusText;\n            }\n            if (onError) {\n              onError(url, message, data, textStatus);\n            }\n          }\n          // error, etc.\n      });\n    }\n  };\n\n  var text = function(indent) {\n    return indent ? JSON.stringify(json(), null, indent) : editor.getValue();\n  };\n\n  var fitGraph= function (){\n    if (graph) {\n      graph.fit();\n    }\n  };\n\n  var hasChanged = function() {\n    var changed = initialData === text();\n    return !changed;\n  };\n\n  return {\n    setData: setData,\n    fromFile: fromFile,\n    fromURL: fromURL,\n    refreshGraph: refreshGraph,\n    setLayout: setLayout,\n    base64Image: base64Image,\n    description: description,\n    changeStyle: changeStyle,\n    fitGraph: fitGraph,\n    text: text,\n    json: json,\n    hasChanged: hasChanged,\n    initialData: initialData\n  };\n};\n\n},{\"./collectdata\":1}]},{},[2])\n\n","/* jshint devel:true */\n/* global saveAs, require, CodeMirror, alertify, cytoscape */\n\n(function() {\n  'use strict';\n\n  var myCodeMirror = new CodeMirror(document.getElementById('editor'), {\n    value: '{}',\n    lineNumbers: true,\n    mode: 'application/json',\n    foldGutter: true,\n    gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter', 'CodeMirror-lint-markers'],\n    lint: {\n      onUpdateLinting: function(annotations) {\n        if (template && (!annotations || annotations.length === 0)) {\n          template.refreshGraph();\n          $('#embed_link').toggle(!template.hasChanged());\n        }\n      }\n    }\n  });\n  myCodeMirror.setSize('100%', '800px');\n\n  var graphArea = $('#graph_area');\n\n  graphArea.css('background-image', 'url(\"images/aws-cloudformation-template.svg\")');\n  graphArea[0].addEventListener('dragover', function(evt) {\n    evt.stopPropagation();\n    evt.preventDefault();\n    evt.dataTransfer.dropEffect = 'copy';\n  }, false);\n  graphArea[0].addEventListener('drop', function(evt) {\n    evt.stopPropagation();\n    evt.preventDefault();\n    loadTemplate(template.fromFile, evt.dataTransfer.files[0]);\n  }, false);\n\n  var template = require('./template').template({\n    'editor': {\n      setValue: function(value) { myCodeMirror.getDoc().setValue(value); },\n      getValue: function() { return myCodeMirror.getDoc().getValue(); }\n    },\n    'cytolib': cytoscape,\n    'graphContainer': graphArea[0],\n    'jsonproxy': $.jsonp\n  });\n  $.ajax({\n    url: 'styles/main.cycss',\n    type: 'GET',\n    dataType: 'text',\n    success: function(responseText) {\n      template.changeStyle(responseText);\n    }\n  });\n\n  var isResizing = false,\n    lastDownX = 0;\n\n  var remoteInput = $('#remote_input');\n\n  $('#remote_input').keypress(function(e) {\n    if (e.which === 13) {\n      loadTemplate(template.fromURL, getTemplateUrl());\n      return false;\n    }\n  });\n\n  var getTemplateUrl = function () {\n    var url = remoteInput.val();\n    if (remoteInput[0].checkValidity()){\n      remoteInput.hide();\n      return url;\n    }\n    return undefined;\n  };\n\n  var loadTemplate = function(loadFn, url) {\n    if (!url) {\n      return;\n    }\n    loadFn(\n      url,\n      function(templateLocation) {\n        graphArea.css('background-image', '');\n        if (typeof url === 'string') {\n          if (remoteInput.val() !== url) {\n            remoteInput.val(url);\n          }\n          var embedUrl = queryTools.createEmbedUrl(window.location, url);\n          $('#embed_link').html('Use <a href=\"'+ embedUrl + '\">'+ embedUrl + '</a> to open directly');\n        }\n        else {\n          $('#embed_link > a').remove();\n        }\n        alertify.success('Loaded template \"' + templateLocation + '\" successfully');\n      },\n      function(templateLocation, reason, e) {\n        alertify.error('Unable to load template \"' + templateLocation + '\" because of ' + reason);\n        console.log(e);\n      }\n    );\n  };\n\n  $('#open_template').click(function(event) {\n    event.preventDefault();\n    $('#template_input').click();\n  });\n  $('#template_input').change(function(event) {\n    loadTemplate(template.fromFile, event.target.files[0]);\n  });\n\n  $('#open_url').click(function(event) {\n    event.preventDefault();\n    if (remoteInput.is(':visible')) {\n      loadTemplate(template.fromURL, getTemplateUrl());\n    }\n    else {\n      remoteInput.show();\n    }\n  });\n\n  $('#save_template').click(function(event) {\n    event.preventDefault();\n    saveAs(\n      new Blob( [template.text(2)], { type: 'text/plain;charset=utf-8' }),\n      template.description() + '.json'\n    );\n    return false;\n  });\n  $('#save_graph').click(function(event) {\n    event.preventDefault();\n    var saveWindow = window.open('savegraph.html');\n    saveWindow.onload = function() {\n      saveWindow.document.getElementById('graphPNG').src = template.base64Image();\n    };\n    return false;\n  });\n  $('#graph_layout').change(function() {\n    template.setLayout($('#graph_layout').val());\n  });\n\n  var container = $('#container'),\n    editorPane = $('#editor_pane');\n\n  $('#border').on('mousedown', function(e) {\n    isResizing = true;\n    lastDownX = e.clientX;\n  });\n\n  $(document).on('mousemove', function(e) {\n    // we don't want to do anything if we aren't resizing.\n    if (!isResizing) {\n      return;\n    }\n\n    var offsetRight = container.width() - (e.clientX - container.offset().left);\n\n    graphArea.css('right', offsetRight);\n    editorPane.css('width', offsetRight);\n  }).on('mouseup', function() {\n    if (isResizing) {\n      template.fitGraph();\n    }\n    // stop resizing\n    isResizing = false;\n  });\n  var queryTools = require('./queryparser');\n  $(document).ready(function() {\n        //----- Parse Query -----//\n  queryTools.parser(window.location.search,{\n    onTemplate: function (url) {\n      loadTemplate(template.fromURL, url);\n    }\n  });\n  //----- Parse Query -----//\n  });\n})();\n","/* jshint devel:true */\n/* global exports */\n\n// findEdges/findIn\n//  - startElement element to traverse through\n//  - makeEdge     call back which expects a reference resource name and\n//                   title of the resource reference\n//  - title        resource title to push to callback function\n//\nexports.findEdges = function findIn (start, makeEdge, title) {\n  'use strict';\n  // If start is an array then let's loop through all elements to find edges\n  //\n  if (start instanceof Array) {\n    start.forEach(function(elem){\n      findIn(elem, makeEdge, title || '');\n    });\n  }\n  // Else if we hit some object and we should delve into it\n  //\n  else if (typeof start === 'object') {\n    // When we only have one key then it's probably some CloudFormation function\n    // we can use to make an make edge with\n    //\n    if (Object.keys(start).length === 1) {\n      var fn = Object.keys(start)[0];\n      // If we hit a Ref, it's definitely a reference of some sorts\n      // usually we only hit this option deep and the title should be available\n      // otherwise give an empty title\n      //\n      if (fn === 'Ref' && typeof start[fn] === 'string') {\n        makeEdge(start[fn], title || '', title);\n      }\n      // An Fn::Join is trickier, we might find edges recursively\n      //\n      else if (fn === 'Fn::Join' && start[fn] instanceof Array) {\n        start[fn][1].forEach(function(elem) {\n          findIn(elem, makeEdge, start[fn][1].join(start[fn][0]));\n        });\n      }\n      // If we see an Fn::GetAtt then make an edge with the reference,\n      // not the attribute\n      //\n      else if (fn === 'Fn::GetAtt' && start[fn] instanceof Array) {\n        makeEdge(start[fn][0], start[fn][1], title);\n      }\n      // Ok, forgot why this path is necessary, I guess it's when we didn't find\n      //  something to easily pull references from and we probably need to keep\n      //  searching anyway\n      //\n      else {\n        for (var key in start) {\n          findIn(start[key], makeEdge, key);\n        }\n      }\n    }\n    // if we have more than one key we have to delve deeper to find edges\n    //\n    else {\n      for (var k in start) {\n        findIn(start[k], makeEdge, k);\n      }\n    }\n  }\n};\n","/* jshint devel:true */\n/* global exports, URI */\n\nexports.parser = function(url, callbacks) {\n    'use strict';\n    if (url) {\n        var queryMap = new URI(url).search(true);\n        if (queryMap.CFTemplateURL && callbacks.onTemplate) {\n            callbacks.onTemplate(queryMap.CFTemplateURL);\n        }\n    }\n};\n\nexports.createEmbedUrl = function(host, target) {\n    'use strict';\n    return new URI(host).search(function(data) {\n        data.CFTemplateURL = target;\n    });\n};","/* jshint devel:true */\n/* global exports, require, cytoscape */\n\nexports.template = function(options) {\n  'use strict';\n\n  var editor = options.editor;\n  var collector = require('./collectdata');\n  var defaultContainer = options.graphContainer;\n  var jsonproxy = options.jsonproxy;\n  var graph;\n  var style;\n  var cyto = options.cytolib || cytoscape;\n  var initialData;\n  var layoutName = 'cose';\n\n  if (!editor || !editor.getValue) {\n    throw 'editor unavailable or doesn\\'t support getValue';\n  }\n  if (!cyto) {\n    throw 'graphing library Cytoscape unavailable';\n  }\n\n  var changeStyle = function(data) {\n    style = data;\n    if (graph) {\n      graph.style(style);\n    }\n  };\n\n  var fromFile = function(file, success, fail) {\n    var reader = new FileReader();\n    reader.onload = function() {\n      setData(reader.result, function() {\n        if (success) {\n          success(file.name);\n        }\n      }, function(reason, e) {\n        if (fail) {\n          fail(file.name, reason, e);\n        }\n      });\n\n    };\n    try {\n      reader.readAsText(file);\n    }\n    catch (e) {\n      if (fail) {\n        fail(file.name, e);\n      }\n    }\n  };\n\n  var setData = function(data, onSuccess, onError) {\n    if (data) {\n      try {\n        var dataString = typeof data === 'string' ? data : JSON.stringify(data, null, 2);\n        var dataObject = typeof data === 'object' ? data : JSON.parse(data);\n\n        editor.setValue(dataString);\n        initialData = text();\n        show(collector.collectCyData(dataObject));\n\n        if (onSuccess) {\n          onSuccess();\n        }\n      }\n      catch (e) {\n        if (onError) {\n          onError('Error processing data as JSON', e);\n        }\n      }\n    }\n    else {\n      if (onError) {\n        onError('No data');\n      }\n    }\n  };\n\n  var refreshGraph = function(){\n    show(collector.collectCyData(json()));\n  };\n\n  var show = function(data, container) {\n    if (!container && !defaultContainer) {\n      throw 'No container available to show data';\n    }\n    graph = cyto({\n      container: container || defaultContainer,\n      elements: data,\n      style: style,\n      layout: {\n        name: layoutName,\n        padding: 5\n      }\n    });\n    graph.boxSelectionEnabled(true);\n  };\n\n  var description = function() {\n    var description = 'template';\n    try {\n      description = json().Description;\n    }\n    catch (e) {}\n    return description;\n  };\n\n  var base64Image = function() {\n    if (!graph) {\n      return;\n    }\n    graph.center();\n    graph.fit();\n    return graph.png({\n      full: false\n    });\n  };\n\n  var json = function() {\n    return JSON.parse(editor.getValue());\n  };\n\n  var setLayout = function(name) {\n    layoutName = name;\n    if (graph) {\n      graph.layout({\n        'name': name\n      });\n    }\n  };\n\n  var fromURL = function(url, success, onError) {\n    if (!jsonproxy) {\n      throw 'No jsonproxy available to request URLs';\n    }\n    if (url) {\n      jsonproxy({\n        url: url,\n        corsSupport: true,\n        success: function(data) {\n          setData(data);\n          if (success) {\n            success(url);\n          }\n        },\n        error: function(data, textStatus) {\n            var message;\n            if (textStatus === 'parsererror') {\n              editor.setValue(data.responseText);\n              message = 'Unable to parse the result as valid JSON';\n            }\n            else {\n              message = 'Unable to load: status ' + data.status + ' ' + data.statusText;\n            }\n            if (onError) {\n              onError(url, message, data, textStatus);\n            }\n          }\n          // error, etc.\n      });\n    }\n  };\n\n  var text = function(indent) {\n    return indent ? JSON.stringify(json(), null, indent) : editor.getValue();\n  };\n\n  var fitGraph= function (){\n    if (graph) {\n      graph.fit();\n    }\n  };\n\n  var hasChanged = function() {\n    var changed = initialData === text();\n    return !changed;\n  };\n\n  return {\n    setData: setData,\n    fromFile: fromFile,\n    fromURL: fromURL,\n    refreshGraph: refreshGraph,\n    setLayout: setLayout,\n    base64Image: base64Image,\n    description: description,\n    changeStyle: changeStyle,\n    fitGraph: fitGraph,\n    text: text,\n    json: json,\n    hasChanged: hasChanged,\n    initialData: initialData\n  };\n};\n"],"sourceRoot":"/source/"}